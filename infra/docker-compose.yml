# ========================================
# COPILOT OS - BASE DOCKER COMPOSE
# ========================================
# Archivo canónico para levantar la plataforma completa (dev, testing, prod).
# Usa perfiles de Docker Compose para habilitar servicios adicionales cuando se necesitan.
#   Desarrollo: make dev / docker compose -f infra/docker-compose.yml up -d
#   Testing:    docker compose -f infra/docker-compose.yml --profile testing up --build
#   Producción: docker compose -f infra/docker-compose.yml --profile production up -d

# CRITICAL: Name must match existing production deployment to reuse volumes
name: ${COMPOSE_PROJECT_NAME:-octavios-chat-bajaware_invex}

services:
  # ========================================
  # MONGODB DATABASE
  # ========================================
  mongodb:
    image: mongo:7.0
    container_name: ${COMPOSE_PROJECT_NAME:-octavios-chat-bajaware_invex}-mongodb
    restart: unless-stopped
    env_file:
      - ../envs/.env
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGODB_USER:-octavios_user}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGODB_PASSWORD:-secure_password_change_me}
      MONGO_INITDB_DATABASE: ${MONGODB_DATABASE:-octavios}
    volumes:
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb
    ports:
      - "${MONGODB_PORT:-27018}:27017"
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.runCommand('ping')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - octavios-network

  # ========================================
  # REDIS CACHE
  # ========================================
  redis:
    image: redis:7-alpine
    container_name: ${COMPOSE_PROJECT_NAME:-octavios-chat-bajaware_invex}-redis
    restart: unless-stopped
    env_file:
      - ../envs/.env
    command: >
      redis-server
      --appendonly yes
      --requirepass ${REDIS_PASSWORD:-redis_password_change_me}
      --maxmemory ${REDIS_MAX_MEMORY:-256mb}
      --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    ports:
      - "${REDIS_PORT:-6380}:6379"
    networks:
      - octavios-network

  # ========================================
  # LANGUAGETOOL - Grammar Checking Service
  # ========================================
  languagetool:
    image: erikvl87/languagetool:latest
    container_name: ${COMPOSE_PROJECT_NAME:-octavios-chat-bajaware_invex}-languagetool
    restart: unless-stopped
    environment:
      - Java_Xms=512m
      - Java_Xmx=1g
    ports:
      - "8010:8010"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8010/v2/languages"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - octavios-network

  # ========================================
  # MINIO - S3-Compatible Object Storage
  # ========================================
  minio:
    image: minio/minio:latest
    container_name: ${COMPOSE_PROJECT_NAME:-octavios-chat-bajaware_invex}-minio
    restart: unless-stopped
    command: server /data --console-address ":9001"
    env_file:
      - ../envs/.env
    environment:
      # Credentials (from .env)
      - MINIO_ROOT_USER=${MINIO_ROOT_USER:-minioadmin}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD:-minioadmin123}

      # Browser configuration
      - MINIO_BROWSER=on
      - MINIO_BROWSER_REDIRECT_URL=http://localhost:9001

      # Storage configuration
      - MINIO_STORAGE_CLASS_STANDARD=EC:0
      - MINIO_API_REQUESTS_MAX=10000
      - MINIO_API_REQUESTS_DEADLINE=10s
    volumes:
      - minio_data:/data
    ports:
      - "${MINIO_API_PORT:-9000}:9000"
      - "${MINIO_CONSOLE_PORT:-9001}:9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - octavios-network

  # ========================================
  # QDRANT - Vector Database for RAG
  # ========================================
  # Architecture Decision Record (ADR):
  # - Single collection strategy with metadata filtering (session_id, document_id)
  # - HNSW index for fast approximate nearest neighbor search
  # - Persistent storage with volume mount
  # - REST API (6333) + gRPC (6334) for flexibility
  # - Memory-mapped storage for efficient large-scale deployments
  qdrant:
    image: qdrant/qdrant:v1.12.5
    container_name: ${COMPOSE_PROJECT_NAME:-octavios-chat-bajaware_invex}-qdrant
    restart: unless-stopped
    env_file:
      - ../envs/.env
    environment:
      # Performance tuning
      # QDRANT__LOG_LEVEL: INFO for production, DEBUG for development
      - QDRANT__LOG_LEVEL=${QDRANT_LOG_LEVEL:-INFO}

      # Storage configuration
      # Use memory-mapped files for better performance with large datasets
      - QDRANT__STORAGE__STORAGE_PATH=/qdrant/storage
      - QDRANT__STORAGE__SNAPSHOTS_PATH=/qdrant/snapshots

      # Service configuration
      - QDRANT__SERVICE__HTTP_PORT=6333
      - QDRANT__SERVICE__GRPC_PORT=6334

      # Collection optimization
      # m: number of edges per node in HNSW graph (default: 16)
      # ef_construct: size of dynamic candidate list for search (default: 100)
      - QDRANT__COLLECTION__OPTIMIZER__DEFAULT_SEGMENT_NUMBER=2

    volumes:
      # Persistent storage for vectors and metadata
      - qdrant_data:/qdrant/storage
      # Snapshots for backup/recovery
      - qdrant_snapshots:/qdrant/snapshots
    ports:
      # REST API - primary interface for Python client
      - "${QDRANT_HTTP_PORT:-6333}:6333"
      # gRPC API - optional high-performance interface
      - "${QDRANT_GRPC_PORT:-6334}:6334"
    # Healthcheck disabled: Qdrant image doesn't include curl/wget
    # Service starts quickly (~2s) so dependency timing is not critical
    # healthcheck:
    #   test: ["CMD-SHELL", "curl -f http://localhost:6333/readyz || exit 1"]
    #   interval: 30s
    #   timeout: 10s
    #   retries: 3
    #   start_period: 40s
    networks:
      - octavios-network

  # ========================================
  # FASTAPI BACKEND (CORE)
  # ========================================
  # Service name: 'backend' - Core/Kernel in Plugin-First Architecture
  # Port 8000 - Main orchestration layer for chat, auth, sessions
  backend:
    build:
      context: ../apps/backend
      dockerfile: Dockerfile
      target: production
    container_name: ${COMPOSE_PROJECT_NAME:-octavios-chat-bajaware_invex}-backend
    restart: unless-stopped
    env_file:
      - ../envs/.env
    command: python -m uvicorn src.main:app --host 0.0.0.0 --port 8000 --workers 1
    environment:
      - PORT=8000
      # Base de datos
      - MONGODB_URL=mongodb://${MONGODB_USER:-octavios_user}:${MONGODB_PASSWORD:-secure_password_change_me}@mongodb:27017/${MONGODB_DATABASE:-octavios}?authSource=admin
      - REDIS_URL=redis://:${REDIS_PASSWORD:-redis_password_change_me}@redis:6379/0

      # Autenticación
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-dev-jwt-secret-change-in-production}
      - SECRET_KEY=${SECRET_KEY:-dev-secret-change-in-production}
      - JWT_ACCESS_TOKEN_EXPIRE_MINUTES=${JWT_ACCESS_TOKEN_EXPIRE_MINUTES:-60}
      - JWT_REFRESH_TOKEN_EXPIRE_DAYS=${JWT_REFRESH_TOKEN_EXPIRE_DAYS:-7}
      - JWT_ALGORITHM=${JWT_ALGORITHM:-HS256}

      # CORS y Hosts permitidos
      - CORS_ORIGINS=${CORS_ORIGINS:-["http://localhost:3000"]}
      - ALLOWED_HOSTS=${ALLOWED_HOSTS:-["localhost","127.0.0.1","web","api","backend"]}

      # Logging y debug
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - DEBUG=${DEBUG:-false}

      # Integraciones externas
      - ALETHEIA_BASE_URL=${ALETHEIA_BASE_URL:-http://localhost:8000}
      - ALETHEIA_API_KEY=${ALETHEIA_API_KEY:-}
      - ALETHEIA_TIMEOUT=${ALETHEIA_TIMEOUT:-120}
      - ALETHEIA_MAX_RETRIES=${ALETHEIA_MAX_RETRIES:-3}
      - LANGUAGETOOL_URL=http://languagetool:8010

      # Object Storage (MinIO)
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=${MINIO_ROOT_USER:-minioadmin}
      - MINIO_SECRET_KEY=${MINIO_ROOT_PASSWORD:-minioadmin123}
      - MINIO_SECURE=false

      # RAG - Qdrant Vector Database
      - QDRANT_HOST=${QDRANT_HOST:-qdrant}
      - QDRANT_PORT=${QDRANT_PORT:-6333}
      - QDRANT_GRPC_PORT=${QDRANT_GRPC_PORT:-6334}
      - QDRANT_COLLECTION_NAME=${QDRANT_COLLECTION_NAME:-rag_documents}
      - QDRANT_EMBEDDING_DIM=${QDRANT_EMBEDDING_DIM:-384}

      # RAG - Session TTL and cleanup
      - RAG_SESSION_TTL_HOURS=${RAG_SESSION_TTL_HOURS:-24}
      - RAG_CLEANUP_INTERVAL_HOURS=${RAG_CLEANUP_INTERVAL_HOURS:-1}

      # Deep Research Feature Flags (P0-DR-KILL-001)
      # GLOBAL KILL SWITCH - dominates all other flags
      - DEEP_RESEARCH_KILL_SWITCH=${DEEP_RESEARCH_KILL_SWITCH:-true}
      # Legacy flags (only active when kill switch is false)
      - DEEP_RESEARCH_ENABLED=${DEEP_RESEARCH_ENABLED:-false}
      - DEEP_RESEARCH_AUTO=${DEEP_RESEARCH_AUTO:-false}
      - DEEP_RESEARCH_COMPLEXITY_THRESHOLD=${DEEP_RESEARCH_COMPLEXITY_THRESHOLD:-0.7}

      # Chat Configuration (P0-CHAT-BASE-004)
      - CHAT_DEFAULT_MODEL=${CHAT_DEFAULT_MODEL:-Saptiva Turbo}
      - CHAT_ALLOWED_MODELS=${CHAT_ALLOWED_MODELS:-Saptiva Turbo,Saptiva Cortex,Saptiva Ops,Saptiva Coder,Saptiva Legacy}

      - SAPTIVA_BASE_URL=${SAPTIVA_BASE_URL:-https://api.saptiva.com}
      - SAPTIVA_TIMEOUT=${SAPTIVA_TIMEOUT:-30}

      # Rate limiting (disabled in development for better DX)
      - RATE_LIMIT_ENABLED=${RATE_LIMIT_ENABLED:-false}
      - RATE_LIMIT_CALLS=${RATE_LIMIT_CALLS:-1000}
      - RATE_LIMIT_PERIOD=${RATE_LIMIT_PERIOD:-60}

      # Observabilidad
      - OTEL_SERVICE_NAME=${OTEL_SERVICE_NAME:-octavios-backend}
      - JAEGER_ENDPOINT=${JAEGER_ENDPOINT:-http://localhost:14268/api/traces}

      # Plugin URLs (for future Plugin-First Architecture)
      - FILE_MANAGER_URL=${FILE_MANAGER_URL:-http://file-manager:8001}

      # MCP Server URLs (bank-advisor for banking analytics)
      - MCP_SERVERS_URLS=${MCP_SERVERS_URLS:-["http://bank-advisor:8002/sse"]}
      - BANK_ADVISOR_URL=${BANK_ADVISOR_URL:-http://bank-advisor:8002}

    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
      languagetool:
        condition: service_healthy
      minio:
        condition: service_healthy
      qdrant:
        condition: service_started
      file-manager:
        condition: service_healthy

    ports:
      - "${API_PORT:-8000}:8000"

    # Volume mount for hot reload in development
    # Source code is mounted to enable immediate reflection of changes
    volumes:
      - ../apps/backend/src:/app/src

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    networks:
      - octavios-network

  # ========================================
  # NEXT.JS FRONTEND
  # ========================================
  web:
    build:
      context: ..
      dockerfile: apps/web/Dockerfile
      target: runner
      args:
        # NEXT_PUBLIC_API_URL not set to enable Next.js proxy
        NEXT_PUBLIC_MAX_FILE_SIZE_MB: ${NEXT_PUBLIC_MAX_FILE_SIZE_MB:-50}
        NODE_ENV: production
        UID: ${UID:-1000}
        GID: ${GID:-1000}
    container_name: ${COMPOSE_PROJECT_NAME:-octavios-chat-bajaware_invex}-web
    restart: unless-stopped
    user: "${UID:-1000}:${GID:-1000}"
    env_file:
      - ../envs/.env
    environment:
      - PORT=3000
      - NODE_ENV=${NODE_ENV:-development}
      - API_BASE_URL=http://backend:8000
      # NEXT_PUBLIC_API_URL not set to enable Next.js proxy (/api/* -> http://backend:8000/api/*)
      - NEXT_PUBLIC_APP_NAME=${NEXT_PUBLIC_APP_NAME:-Saptiva Copilot OS}
      - NEXT_PUBLIC_APP_VERSION=${NEXT_PUBLIC_APP_VERSION:-1.0.0}
      - NEXT_PUBLIC_ENABLE_STREAMING=${NEXT_PUBLIC_ENABLE_STREAMING:-true}
      - NEXT_PUBLIC_ENABLE_DEEP_RESEARCH=${NEXT_PUBLIC_ENABLE_DEEP_RESEARCH:-true}
      - NEXT_PUBLIC_DEFAULT_MODEL=${NEXT_PUBLIC_DEFAULT_MODEL:-SAPTIVA_CORTEX}
      - UID=${UID:-1000}
      - GID=${GID:-1000}

      # Deep Research Kill Switch (client-side awareness only)
      - DEEP_RESEARCH_ENABLED=${DEEP_RESEARCH_ENABLED:-false}

      # SAPTIVA Configuration (ENV-only per security requirements)
      - SAPTIVA_API_KEY=${SAPTIVA_API_KEY:-}
      - NEXT_PUBLIC_SAPTIVA_API_KEY=${NEXT_PUBLIC_SAPTIVA_API_KEY:-}
      - NEXT_PUBLIC_SAPTIVA_BASE_URL=${NEXT_PUBLIC_SAPTIVA_BASE_URL:-https://api.saptiva.com}

    ports:
      - "${WEB_PORT:-3000}:3000"

    # Volume mounts for hot reload in development
    # Source code is mounted to enable immediate reflection of changes
    # node_modules is persisted in a named volume to survive container recreation
    # PRODUCTION: Disabled hot-reload volumes
    #     volumes:
    # PRODUCTION: Disabled hot-reload volumes
    #       - ../apps/web:/app/apps/web
    # PRODUCTION: Disabled hot-reload volumes
    #       - web_node_modules:/app/apps/web/node_modules
    # PRODUCTION: Disabled hot-reload volumes
    #       - /app/apps/web/.next

    depends_on:
      backend:
        condition: service_healthy

    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    networks:
      - octavios-network

  # ========================================
  # PRODUCTION EDGE (NGINX)
  # ========================================
  nginx:
    image: nginx:1.25-alpine
    container_name: ${COMPOSE_PROJECT_NAME:-octavios-chat-bajaware_invex}-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - /etc/letsencrypt:/etc/letsencrypt:ro
      - nginx_logs:/var/log/nginx
    depends_on:
      - web
      - backend
    profiles:
      - production
    networks:
      - octavios-network

  # ========================================
  # TESTING UTILITIES
  # ========================================
  playwright:
    build:
      context: ..
      dockerfile: tests/Dockerfile.playwright
    container_name: ${COMPOSE_PROJECT_NAME:-octavios-chat-bajaware_invex}-playwright
    environment:
      - PLAYWRIGHT_BASE_URL=http://web:3000
      - API_BASE_URL=http://backend:8000
    volumes:
      - ../tests:/app/tests
      - ../playwright-report:/app/playwright-report
    depends_on:
      web:
        condition: service_healthy
      backend:
        condition: service_healthy
    profiles:
      - testing
    networks:
      - octavios-network

# ========================================
  # POSTGRESQL - BankAdvisor Database
  # ========================================
  # Dedicated PostgreSQL for bank-advisor plugin (INVEX banking data)
  postgres:
    image: postgres:15-alpine
    container_name: ${COMPOSE_PROJECT_NAME:-octavios-chat-bajaware_invex}-postgres
    restart: unless-stopped
    env_file:
      - ../envs/.env
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-octavios}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-secure_postgres_password}
      - POSTGRES_DB=${POSTGRES_DB:-bankadvisor}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-octavios} -d ${POSTGRES_DB:-bankadvisor}"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - octavios-network

  # ========================================
  # BANK ADVISOR - Private MCP Plugin
  # ========================================
  # Enterprise banking analytics via MCP (Model Context Protocol)
  # Provides bank_analytics tool for CNBV/INVEX data analysis
  bank-advisor:
    build:
      context: ..
      dockerfile: plugins/bank-advisor-private/Dockerfile
    container_name: ${COMPOSE_PROJECT_NAME:-octavios-chat-bajaware_invex}-bank-advisor
    restart: unless-stopped
    env_file:
      - ../envs/.env
    environment:
      - HOST=0.0.0.0
      - PORT=8002
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_USER=${POSTGRES_USER:-octavios}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-secure_postgres_password}
      - POSTGRES_DB=${POSTGRES_DB:-bankadvisor}
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER:-octavios}:${POSTGRES_PASSWORD:-secure_postgres_password}@postgres:5432/${POSTGRES_DB:-bankadvisor}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    ports:
      - "${BANK_ADVISOR_PORT:-8002}:8002"
    volumes:
      # Hot reload in development
      - ../plugins/bank-advisor-private/src:/app/src
      - ../plugins/bank-advisor-private/data:/app/data
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - octavios-network

  # ========================================
  # FILE MANAGER - Public Plugin Service
  # ========================================
  # Plugin-First Architecture: Public plugin for file operations
  # Other plugins consume files from this service
  file-manager:
    build:
      context: ..
      dockerfile: plugins/public/file-manager/Dockerfile
    container_name: ${COMPOSE_PROJECT_NAME:-octavios-chat-bajaware_invex}-file-manager
    restart: unless-stopped
    env_file:
      - ../envs/.env
    environment:
      - PORT=8001
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=${MINIO_ROOT_USER:-minioadmin}
      - MINIO_SECRET_KEY=${MINIO_ROOT_PASSWORD:-minioadmin123}
      - MINIO_BUCKET_DOCUMENTS=documents
      - REDIS_URL=redis://:${REDIS_PASSWORD:-redis_password_change_me}@redis:6379/0
      - MAX_FILE_SIZE_MB=${MAX_FILE_SIZE_MB:-50}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    ports:
      - "${FILE_MANAGER_PORT:-8001}:8001"
    volumes:
      # Hot reload in development
      - ../plugins/public/file-manager/src:/app/src
    depends_on:
      minio:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - octavios-network


# ========================================
# VOLUMES
# ========================================
volumes:
  # Data volumes - simple Docker-managed volumes for development
  # For production bind mounts, override these in docker-compose.prod.yml
  mongodb_data:
    driver: local

  mongodb_config:
    driver: local

  redis_data:
    driver: local

  minio_data:
    driver: local

  # PostgreSQL for bank-advisor plugin
  postgres_data:
    driver: local

  # These volumes always use Docker-managed storage
  nginx_logs:
    driver: local

  # Next.js build cache volumes to avoid permission issues
  next_cache:
    driver: local
  next_standalone_cache:
    driver: local

  # Qdrant persistent storage (new service, can use Docker-managed volumes)
  qdrant_data:
    driver: local
  qdrant_snapshots:
    driver: local

  # Web node_modules persistence (survive container recreation)
  web_node_modules:
    driver: local

# ========================================
# NETWORKS
# ========================================
networks:
  octavios-network:
    driver: bridge
