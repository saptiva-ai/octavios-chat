# ========================================
# COPILOTOS BRIDGE - APPLICATION LAYER (BLUE/GREEN)
# ========================================
# Este archivo define SOLO los servicios de aplicación (API + Web)
# sin bases de datos, para permitir deployments blue/green.
#
# Los servicios de aplicación se conectan a la red de datos compartida
# definida en docker-compose.data.yml.
#
# Usage:
#   # Blue stack
#   docker compose -p copilotos-blue -f infra/docker-compose.app.yml up -d
#
#   # Green stack
#   docker compose -p copilotos-green -f infra/docker-compose.app.yml up -d
#
# IMPORTANTE: No usar puertos fijos aquí. Los puertos serán asignados
# dinámicamente y controlados por nginx/proxy en base al color activo.

services:
  # ========================================
  # FASTAPI BACKEND
  # ========================================
  api:
    image: ${API_IMAGE:-ghcr.io/jazielflo/copilotos-bridge/api:latest}
    restart: unless-stopped
    env_file:
      - ../envs/.env.prod
    environment:
      # Base de datos (apuntan al contenedor de datos compartido)
      - MONGODB_URL=mongodb://${MONGODB_USER:-copilotos_user}:${MONGODB_PASSWORD}@copilotos-data-mongodb:27017/${MONGODB_DATABASE:-copilotos}?authSource=admin
      - REDIS_URL=redis://:${REDIS_PASSWORD}@copilotos-data-redis:6379/0

      # Autenticación
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - SECRET_KEY=${SECRET_KEY}
      - JWT_ACCESS_TOKEN_EXPIRE_MINUTES=${JWT_ACCESS_TOKEN_EXPIRE_MINUTES:-60}
      - JWT_REFRESH_TOKEN_EXPIRE_DAYS=${JWT_REFRESH_TOKEN_EXPIRE_DAYS:-7}
      - JWT_ALGORITHM=${JWT_ALGORITHM:-HS256}

      # CORS y Hosts permitidos
      - CORS_ORIGINS=${CORS_ORIGINS}
      - ALLOWED_HOSTS=${ALLOWED_HOSTS}

      # Logging y debug
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - DEBUG=${DEBUG:-false}

      # Integraciones externas
      - ALETHEIA_BASE_URL=${ALETHEIA_BASE_URL}
      - ALETHEIA_API_KEY=${ALETHEIA_API_KEY:-}
      - ALETHEIA_TIMEOUT=${ALETHEIA_TIMEOUT:-120}
      - ALETHEIA_MAX_RETRIES=${ALETHEIA_MAX_RETRIES:-3}

      # Deep Research Feature Flags
      - DEEP_RESEARCH_KILL_SWITCH=${DEEP_RESEARCH_KILL_SWITCH:-true}
      - DEEP_RESEARCH_ENABLED=${DEEP_RESEARCH_ENABLED:-false}
      - DEEP_RESEARCH_AUTO=${DEEP_RESEARCH_AUTO:-false}

      # Chat Configuration
      - CHAT_DEFAULT_MODEL=${CHAT_DEFAULT_MODEL:-Saptiva Turbo}
      - CHAT_ALLOWED_MODELS=${CHAT_ALLOWED_MODELS:-Saptiva Turbo,Saptiva Cortex,Saptiva Ops,Saptiva Coder}

      - SAPTIVA_BASE_URL=${SAPTIVA_BASE_URL:-https://api.saptiva.com}
      - SAPTIVA_API_KEY=${SAPTIVA_API_KEY}
      - SAPTIVA_TIMEOUT=${SAPTIVA_TIMEOUT:-30}
      - SAPTIVA_MAX_RETRIES=${SAPTIVA_MAX_RETRIES:-3}

      # Rate limiting
      - RATE_LIMIT_ENABLED=${RATE_LIMIT_ENABLED:-true}
      - RATE_LIMIT_CALLS=${RATE_LIMIT_CALLS:-100}
      - RATE_LIMIT_PERIOD=${RATE_LIMIT_PERIOD:-60}

      # Observabilidad
      - OTEL_SERVICE_NAME=${OTEL_SERVICE_NAME:-copilotos-bridge}
      - JAEGER_ENDPOINT=${JAEGER_ENDPOINT:-}

    # NO exponer puertos aquí - se manejan vía nginx/proxy
    # Los puertos internos (8001) son accesibles dentro de la red Docker
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - copilotos-data  # Conecta a la red de datos compartida
      - app-internal    # Red interna para comunicación con web

  # ========================================
  # NEXT.JS FRONTEND
  # ========================================
  web:
    image: ${WEB_IMAGE:-ghcr.io/jazielflo/copilotos-bridge/web:latest}
    restart: unless-stopped
    env_file:
      - ../envs/.env.prod
    environment:
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}
      - NODE_ENV=production
      - HOSTNAME=0.0.0.0
    depends_on:
      api:
        condition: service_healthy
    # NO exponer puertos aquí - se manejan vía nginx/proxy
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - app-internal

# ========================================
# REDES
# ========================================
networks:
  # Red de datos compartida (externa, creada por docker-compose.data.yml)
  copilotos-data:
    external: true
    name: copilotos-data-network

  # Red interna para comunicación entre web y api
  app-internal:
    driver: bridge
