services:
  web:
    user: "${UID:-1000}:${GID:-1000}"         # corre como tu usuario, no root
    build:
      target: dev
    command:
      - /bin/sh
      - -c
      - |
        # Always install/update dependencies (ensures consistency with package.json)
        echo "ðŸŸ¡ Installing dependencies..."
        cd /app && pnpm install --frozen-lockfile
        # Start development server
        cd /app/apps/web && pnpm dev --hostname 0.0.0.0 --port 3000
    environment:
      - NODE_ENV=development
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-}
      - DEEP_RESEARCH_ENABLED=${DEEP_RESEARCH_ENABLED:-true}
      - CI=true
    volumes:
      - ../pnpm-lock.yaml:/app/pnpm-lock.yaml:ro
      - ../pnpm-workspace.yaml:/app/pnpm-workspace.yaml:ro
      - ../packages:/app/packages
      - ../apps/web:/app/apps/web
      # Named volume to preserve container-installed dependencies
      # This overrides the bind mount for node_modules specifically
      - web_node_modules:/app/apps/web/node_modules
      # Anonymous volume for build artifacts
      - /app/apps/web/.next

  backend:
    user: "${UID:-1000}:${GID:-1000}"  # Run as host user for volume permissions
    build:
      target: development  # Use development stage with pytest and testing tools
    env_file:
      - ../envs/.env
    volumes:
      # Mount source code for hot reload
      - ../apps/backend/src:/app/src
      - ../apps/backend/tests:/app/tests:ro
      - ../apps/backend/pytest.ini:/app/pytest.ini:ro
      - ../.coveragerc:/app/.coveragerc:ro
    environment:
      - DEEP_RESEARCH_ENABLED=${DEEP_RESEARCH_ENABLED:-true}
      - PYTHONPATH=/usr/local/lib/python3.11/site-packages:/app/src  # Ensure vendor MCP takes precedence
      - COVERAGE_FILE=/tmp/.coverage

  bank-advisor:
    environment:
      # Override backend path for Docker environment
      - BACKEND_SRC_PATH=/backend_shared/src
    volumes:
      # Mount source code for hot reload
      - ../plugins/bank-advisor-private/src:/app/src
      - ../plugins/bank-advisor-private/data:/app/data:ro
      - ../plugins/bank-advisor-private/migrations:/app/migrations:ro
      # Mount backend source for shared SAPTIVA client import (BA-P0-001)
      - ../apps/backend/src:/backend_shared/src:ro

volumes:
  web_node_modules:
    driver: local
