services:
  web:
    user: "${UID:-1000}:${GID:-1000}"         # corre como tu usuario, no root
    build:
      target: dev
    command:
      - /bin/sh
      - -c
      - |
        # Install dependencies if node_modules is empty (first run with named volume)
        if [ ! -d "node_modules/next" ]; then
          echo "ðŸŸ¡ Installing dependencies (first run)..."
          cd /app && pnpm install --frozen-lockfile
        fi
        # Start development server
        pnpm dev --hostname 0.0.0.0 --port 3000
    environment:
      - NODE_ENV=development
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-http://localhost:8001}
      - DEEP_RESEARCH_ENABLED=${DEEP_RESEARCH_ENABLED:-true}
      - CI=true
    volumes:
      - ../pnpm-lock.yaml:/app/pnpm-lock.yaml:ro
      - ../pnpm-workspace.yaml:/app/pnpm-workspace.yaml:ro
      - ../packages:/app/packages
      - ../apps/web:/app/apps/web
      # Named volume to preserve container-installed dependencies
      # This overrides the bind mount for node_modules specifically
      - web_node_modules:/app/apps/web/node_modules
      # Anonymous volume for build artifacts
      - /app/apps/web/.next

  api:
    user: "${UID:-1000}:${GID:-1000}"  # Run as host user for volume permissions
    build:
      target: development  # Use development stage with pytest and testing tools
    volumes:
      # Mount source code for hot reload
      - ../apps/api/src:/app/src:ro
      - ../apps/api/tests:/app/tests:ro
    environment:
      - DEEP_RESEARCH_ENABLED=${DEEP_RESEARCH_ENABLED:-true}
      - PYTHONPATH=/app/src  # Add src to Python path for tests

volumes:
  web_node_modules:
    driver: local
