name: BankAdvisor CI

on:
  push:
    branches: [main, develop]
    paths:
      - 'plugins/bank-advisor-private/**'
  pull_request:
    branches: [main, develop]
    paths:
      - 'plugins/bank-advisor-private/**'
  workflow_dispatch:
    inputs:
      run_smoke:
        description: 'Run smoke test (requires running container)'
        required: false
        default: 'false'
        type: boolean

jobs:
  # ============================================================================
  # Unit Tests
  # ============================================================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: plugins/bank-advisor-private

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: plugins/bank-advisor-private/requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-cov

      - name: Run unit tests
        run: |
          pytest tests/ -v \
            --ignore=tests/test_e2e_demo_flows.py \
            --cov=src/bankadvisor \
            --cov-report=xml:coverage-unit.xml \
            --cov-report=term-missing
        env:
          PYTHONPATH: src

      - name: Upload coverage
        if: always()
        uses: codecov/codecov-action@v4
        with:
          files: plugins/bank-advisor-private/coverage-unit.xml
          flags: bankadvisor-unit
          name: bankadvisor-unit-coverage

  # ============================================================================
  # Visualization Tests (Priority 9)
  # ============================================================================
  visualization-tests:
    name: Visualization Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: plugins/bank-advisor-private

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: plugins/bank-advisor-private/requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio

      - name: Run visualization tests
        run: |
          pytest tests/test_9_priority_visualizations.py -v
        env:
          PYTHONPATH: src

  # ============================================================================
  # Smoke Test (Manual / Workflow Dispatch)
  # ============================================================================
  smoke-test:
    name: Smoke Test (Manual)
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && inputs.run_smoke == 'true'
    defaults:
      run:
        working-directory: plugins/bank-advisor-private

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install requests
        run: pip install requests

      - name: Run smoke test
        run: |
          python scripts/smoke_demo_bank_analytics.py --host ${{ vars.BANKADVISOR_HOST || 'localhost' }} --port ${{ vars.BANKADVISOR_PORT || '8002' }}
        env:
          PYTHONPATH: src

  # ============================================================================
  # CI Health Check
  # ============================================================================
  ci-health:
    name: CI Health Check
    runs-on: ubuntu-latest
    needs: [unit-tests, visualization-tests]
    if: always()

    steps:
      - name: Check CI status
        run: |
          echo "Unit Tests: ${{ needs.unit-tests.result }}"
          echo "Visualization Tests: ${{ needs.visualization-tests.result }}"

          if [ "${{ needs.unit-tests.result }}" != "success" ]; then
            echo "Unit tests failed"
            exit 1
          fi

          if [ "${{ needs.visualization-tests.result }}" != "success" ]; then
            echo "Visualization tests failed"
            exit 1
          fi

          echo "BankAdvisor CI passed"
