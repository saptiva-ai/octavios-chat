name: MCP (Model Context Protocol) CI

on:
  push:
    branches: [main, develop]
    paths:
      - 'apps/api/src/mcp/**'
      - 'apps/api/tests/mcp/**'
      - 'apps/web/src/lib/mcp/**'
  pull_request:
    branches: [main, develop]
    paths:
      - 'apps/api/src/mcp/**'
      - 'apps/api/tests/mcp/**'
      - 'apps/web/src/lib/mcp/**'
  workflow_dispatch:

jobs:
  # ============================================================================
  # MCP Backend Tests
  # ============================================================================
  mcp-backend:
    name: MCP Backend Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/api

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for diff-coverage

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: apps/api/requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio pytest-mock httpx
          pip install fastmcp>=2.0.0 prometheus-client>=0.19.0

      - name: Run MCP unit tests
        run: |
          pytest tests/mcp/ -v -m "mcp and unit" \
            --cov=src/mcp \
            --cov-report=xml:coverage-mcp-unit.xml \
            --cov-report=term-missing \
            --cov-fail-under=80

      - name: Run MCP integration tests
        run: |
          pytest tests/mcp/ -v -m "mcp and integration" \
            --cov=src/mcp \
            --cov-append \
            --cov-report=xml:coverage-mcp-integration.xml \
            --cov-report=term-missing

      - name: Run MCP security tests
        run: |
          pytest tests/mcp/ -v -m "mcp_security" \
            --cov=src/mcp/security \
            --cov-report=xml:coverage-mcp-security.xml \
            --cov-report=term-missing \
            --cov-fail-under=90

      - name: Run MCP task management tests
        run: |
          pytest tests/mcp/ -v -m "mcp_tasks" \
            --cov=src/mcp/tasks \
            --cov-append \
            --cov-report=xml:coverage-mcp-tasks.xml \
            --cov-report=term-missing

      - name: Run MCP versioning tests
        run: |
          pytest tests/mcp/ -v -m "mcp_versioning" \
            --cov=src/mcp/versioning \
            --cov-report=xml:coverage-mcp-versioning.xml \
            --cov-report=term-missing

      - name: Upload MCP coverage reports
        if: always()
        uses: codecov/codecov-action@v4
        with:
          files: |
            apps/api/coverage-mcp-unit.xml
            apps/api/coverage-mcp-integration.xml
            apps/api/coverage-mcp-security.xml
            apps/api/coverage-mcp-tasks.xml
            apps/api/coverage-mcp-versioning.xml
          flags: mcp-backend
          name: mcp-backend-coverage

  # ============================================================================
  # MCP Diff-Coverage Tests (Pull Requests Only)
  # ============================================================================
  mcp-diff-coverage:
    name: MCP Diff-Coverage Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    defaults:
      run:
        working-directory: apps/api

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git diff

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: apps/api/requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio pytest-mock httpx
          pip install fastmcp>=2.0.0 prometheus-client>=0.19.0

      - name: Run diff-coverage tests
        run: |
          pytest tests/ -v \
            --diff-coverage \
            --diff-base=origin/${{ github.base_ref }} \
            --mcp-only \
            --cov=src/mcp \
            --cov-report=xml:coverage-mcp-diff.xml \
            --cov-report=term-missing
        env:
          BASE_BRANCH: ${{ github.base_ref }}

      - name: Comment PR with diff-coverage results
        if: always()
        uses: codecov/codecov-action@v4
        with:
          files: apps/api/coverage-mcp-diff.xml
          flags: mcp-diff
          name: mcp-diff-coverage

  # ============================================================================
  # MCP Frontend TypeScript Tests
  # ============================================================================
  mcp-frontend:
    name: MCP Frontend Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/web

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"
          cache-dependency-path: pnpm-lock.yaml

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install

      - name: Type check MCP SDK
        run: pnpm exec tsc --noEmit src/lib/mcp/*.ts || true

      - name: Lint MCP SDK
        run: pnpm exec eslint src/lib/mcp/ --max-warnings 0 || true

      - name: Run MCP SDK tests (if available)
        run: |
          if [ -d "src/lib/mcp/__tests__" ]; then
            pnpm test src/lib/mcp/
          else
            echo "No MCP tests found (expected)"
          fi

  # ============================================================================
  # MCP Integration Health Check
  # ============================================================================
  mcp-health:
    name: MCP Integration Health Check
    runs-on: ubuntu-latest
    needs: [mcp-backend, mcp-frontend]
    if: always()

    steps:
      - name: Check MCP CI status
        run: |
          echo "MCP Backend: ${{ needs.mcp-backend.result }}"
          echo "MCP Frontend: ${{ needs.mcp-frontend.result }}"

          if [ "${{ needs.mcp-backend.result }}" != "success" ]; then
            echo "❌ MCP Backend tests failed"
            exit 1
          fi

          if [ "${{ needs.mcp-frontend.result }}" != "success" ]; then
            echo "⚠️  MCP Frontend tests failed (non-blocking)"
          fi

          echo "✅ MCP Integration Health Check passed"
