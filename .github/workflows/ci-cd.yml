name: CI + CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  # ============================================================================
  # Backend Tests
  # ============================================================================
  backend:
    name: Backend Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/api

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: apps/api/requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio pytest-mock httpx safety

      - name: Security audit with Safety
        run: |
          safety check --ignore 64459 --ignore 64396

      - name: Run tests
        run: |
          pytest -q --cov=src --cov-report=xml --cov-report=term \
            --ignore=tests/integration \
            --ignore=tests/e2e \
            --ignore=tests/debug \
            --ignore=tests/manual \
            --ignore=tests/unit \
            --ignore=tests/test_auth_email_normalization.py \
            --ignore=tests/test_intent.py \
            --ignore=tests/test_messages_images.py \
            --ignore=tests_legacy

      - name: Upload coverage to Codecov (optional)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: codecov/codecov-action@v4
        with:
          file: apps/api/coverage.xml
          flags: backend
          fail_ci_if_error: false
        continue-on-error: true

  # ============================================================================
  # Frontend Tests
  # ============================================================================
  frontend:
    name: Frontend Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure frontend environment
        run: |
          echo "NEXT_PUBLIC_API_URL=http://localhost:8001" >> $GITHUB_ENV
          echo "NEXT_PUBLIC_ENABLE_MSW=false" >> $GITHUB_ENV

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8.15.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"
          cache-dependency-path: pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Type check
        run: pnpm --filter web typecheck

      - name: Lint
        run: pnpm --filter web lint

      - name: Run tests
        run: pnpm --filter web test -- --coverage

      - name: Upload coverage to Codecov (optional)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: codecov/codecov-action@v4
        with:
          directory: apps/web/coverage
          flags: frontend
          fail_ci_if_error: false
        continue-on-error: true

  # ============================================================================
  # Backend Integration Tests (Pytest)
  # ============================================================================
  backend-integration:
    name: Backend Integration Tests
    runs-on: ubuntu-latest
    needs: [backend]
    defaults:
      run:
        working-directory: apps/api

    services:
      mongodb:
        image: mongo:7
        ports:
          - 27018:27017
        env:
          MONGO_INITDB_ROOT_USERNAME: copilotos_user
          MONGO_INITDB_ROOT_PASSWORD: test_password
          MONGO_INITDB_DATABASE: copilotos
        options: >-
          --health-cmd "mongosh --eval 'db.runCommand({ ping: 1 })'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6380:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: apps/api/requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio httpx

      - name: Configure environment for tests
        run: |
          cat > ../../envs/.env << EOF
          MONGODB_USER=copilotos_user
          MONGODB_PASSWORD=test_password
          MONGODB_DATABASE=copilotos
          JWT_SECRET_KEY=$(openssl rand -base64 64)
          SECRET_KEY=$(openssl rand -hex 32)
          JWT_ACCESS_TOKEN_EXPIRE_MINUTES=60
          JWT_REFRESH_TOKEN_EXPIRE_DAYS=7
          EOF

      - name: Wait for services
        run: |
          echo "Waiting for MongoDB..."
          timeout 30 bash -c 'until nc -z localhost 27018; do sleep 1; done'
          echo "Waiting for Redis..."
          timeout 30 bash -c 'until nc -z localhost 6380; do sleep 1; done'
          sleep 5

      - name: Run integration tests - Auth
        run: pytest tests/integration/test_auth_flow.py -v --tb=short

      - name: Run integration tests - Chat
        run: pytest tests/integration/test_chat_file_context.py -v --tb=short

      - name: Run integration tests - Attachments Policy
        run: pytest tests/integration/test_chat_attachments_no_inheritance.py -v --tb=short

      - name: Generate test report
        if: always()
        run: |
          pytest tests/integration/ --tb=short --junit-xml=../../test-results/integration-tests.xml || true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: test-results/integration-tests.xml
          retention-days: 7

  # ============================================================================
  # Integration Tests (Docker Compose Smoke)
  # ============================================================================
  integration:
    name: Integration Smoke Tests
    runs-on: ubuntu-latest
    needs: [backend, frontend]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create environment file for CI
        run: |
          cp envs/.env.local.example envs/.env || true
          echo "MONGODB_PASSWORD=test_password" >> envs/.env
          echo "REDIS_PASSWORD=test_password" >> envs/.env
          echo "JWT_SECRET_KEY=$(openssl rand -hex 32)" >> envs/.env
          echo "API_KEY=$(openssl rand -hex 16)" >> envs/.env

      - name: Start services
        run: |
          docker compose -f infra/docker-compose.yml up -d --wait
          sleep 10

      - name: Run integration smoke tests
        run: VERIFY_INCLUDE_DEV=false make verify

      - name: Show running containers
        if: always()
        run: docker compose -f infra/docker-compose.yml ps

      - name: Teardown
        if: always()
        run: docker compose -f infra/docker-compose.yml down -v

  # ============================================================================
  # E2E Tests (Playwright) - TEMPORARILY DISABLED FOR FAST DEPLOYMENT
  # ============================================================================
  # Uncomment to re-enable E2E tests
  # e2e:
  #   name: E2E Tests (Playwright)
  #   runs-on: ubuntu-latest
  #   needs: [backend, frontend, backend-integration]
  #   # Run on main, or on PRs explicitly labeled run-e2e
  #   if: |
  #     github.ref == 'refs/heads/main' ||
  #     (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'run-e2e'))
  #
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #
  #     - name: Setup pnpm
  #       uses: pnpm/action-setup@v4
  #       with:
  #         version: 8.15.0
  #
  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: "20"
  #         cache: "pnpm"
  #         cache-dependency-path: pnpm-lock.yaml
  #
  #     - name: Install dependencies
  #       run: pnpm install --frozen-lockfile
  #
  #     - name: Install Playwright browsers
  #       run: npx playwright install --with-deps chromium
  #
  #     - name: Create environment file for CI
  #       run: |
  #         cp envs/.env.local.example envs/.env || true
  #         echo "MONGODB_USER=copilotos_user" >> envs/.env
  #         echo "MONGODB_PASSWORD=test_password" >> envs/.env
  #         echo "MONGODB_DATABASE=copilotos" >> envs/.env
  #         echo "REDIS_PASSWORD=test_password" >> envs/.env
  #         echo "JWT_SECRET_KEY=$(openssl rand -base64 64)" >> envs/.env
  #         echo "SECRET_KEY=test-secret-key" >> envs/.env
  #         echo "SAPTIVA_API_KEY=test-api-key" >> envs/.env
  #         echo "SAPTIVA_BASE_URL=https://api.saptiva.com" >> envs/.env
  #
  #     - name: Start services
  #       run: |
  #         docker compose -f infra/docker-compose.yml up -d --wait
  #         sleep 10
  #
  #     - name: Wait for services to be healthy
  #       run: |
  #         echo "Waiting for API..."
  #         timeout 60 bash -c 'until curl -f http://localhost:8001/api/health; do sleep 2; done'
  #         echo "Waiting for Frontend..."
  #         timeout 60 bash -c 'until curl -f http://localhost:3000; do sleep 2; done'
  #
  #     - name: Create demo user
  #       run: |
  #         make create-demo-user || echo "Demo user may already exist"
  #         sleep 2
  #
  #     - name: Run E2E tests (Chromium only for CI)
  #       env:
  #         CI: true
  #       run: npx playwright test --project=chromium --reporter=list,html
  #
  #     - name: Upload Playwright report
  #       if: always()
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: playwright-report
  #         path: playwright-report/
  #         retention-days: 7
  #
  #     - name: Upload test results
  #       if: always()
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: e2e-test-results
  #         path: test-results/
  #         retention-days: 7
  #
  #     - name: Show logs on failure
  #       if: failure()
  #       run: |
  #         echo "=== API Logs ==="
  #         docker compose -f infra/docker-compose.yml logs api --tail=100
  #         echo "=== Frontend Logs ==="
  #         docker compose -f infra/docker-compose.yml logs web --tail=100
  #
  #     - name: Teardown
  #       if: always()
  #       run: docker compose -f infra/docker-compose.yml down -v

  # ============================================================================
  # Deploy to Production (tar-based)
  # ============================================================================
  deploy_tar:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [backend, frontend, backend-integration, integration]
    # Only deploy on push to main
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.PROD_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          # Extract host from PROD_SERVER (format: user@host)
          HOST=$(echo "${{ secrets.PROD_SERVER }}" | cut -d'@' -f2)
          ssh-keyscan -H "$HOST" >> ~/.ssh/known_hosts

      - name: Prepare deployment version
        id: prepare_version
        run: |
          GIT_SHA=$(git rev-parse --short HEAD)
          TIMESTAMP=$(date -u +%Y%m%d-%H%M%S)
          VERSION="${GIT_SHA}-${TIMESTAMP}"
          echo "DEPLOY_VERSION=$VERSION" >> "$GITHUB_ENV"
          echo "deploy_version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Deployment version: $VERSION"

      - name: Docker login (registry)
        env:
          REGISTRY_URL: ${{ secrets.REGISTRY_URL }}
          REGISTRY_USER: ${{ secrets.REGISTRY_USER }}
          REGISTRY_TOKEN: ${{ secrets.REGISTRY_TOKEN }}
        run: |
          if [ -z "$REGISTRY_URL" ] || [ -z "$REGISTRY_USER" ] || [ -z "$REGISTRY_TOKEN" ]; then
            echo "Registry credentials not configured. Skipping login."
            exit 0
          fi
          REGISTRY_HOST=$(echo "$REGISTRY_URL" | cut -d'/' -f1)
          echo "$REGISTRY_TOKEN" | docker login "$REGISTRY_HOST" -u "$REGISTRY_USER" --password-stdin

      - name: Deploy (registry first, tar fallback)
        env:
          PROD_SERVER_HOST: ${{ secrets.PROD_SERVER }}
          DEPLOY_SERVER: ${{ secrets.PROD_SERVER }}
          PROD_DEPLOY_PATH: ${{ secrets.PROD_DEPLOY_PATH }}
          PROD_DOMAIN: ${{ secrets.PROD_DOMAIN }}
          REGISTRY_URL: ${{ secrets.REGISTRY_URL }}
          REGISTRY_USER: ${{ secrets.REGISTRY_USER }}
          REGISTRY_TOKEN: ${{ secrets.REGISTRY_TOKEN }}
          DEPLOY_VERSION: ${{ env.DEPLOY_VERSION }}
        run: |
          set -o pipefail
          echo "Starting deployment with version: ${DEPLOY_VERSION}"
          if [ -z "$REGISTRY_URL" ] || [ -z "$REGISTRY_USER" ] || [ -z "$REGISTRY_TOKEN" ]; then
            echo "Registry credentials missing. Running TAR deployment directly."
            ./scripts/deploy.sh tar --force
            exit 0
          fi

          if ./scripts/deploy.sh registry --force; then
            echo "Registry deployment completed successfully."
          else
            echo "Registry deployment failed. Attempting TAR fallback..."
            ./scripts/deploy.sh tar --force
          fi

  # ============================================================================
  # Security Scan (Optional)
  # ============================================================================
  # Note: Uploading SARIF results requires GitHub Advanced Security to be enabled.
  # If not available, the scan will still run but results won't be uploaded.
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    # Run on PRs and main branch
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'
    permissions:
      contents: read
      security-events: write
      actions: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
        continue-on-error: true

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
        continue-on-error: true
