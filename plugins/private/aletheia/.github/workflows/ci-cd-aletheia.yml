name: "ðŸš€ Aletheia CI/CD"

on:
  push:
    branches:
      - develop
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment"
        required: true
        default: "staging"
        type: choice
        options:
          - staging
          - production
      image_tag:
        description: "Override image tag (optional for manual deploys)"
        required: false
        default: ""
        type: string
      skip_tests:
        description: "Skip quality gate (emergency deploy only)"
        required: true
        default: false
        type: boolean

env:
  PYTHON_VERSION: "3.11"
  FORCE_COLOR: "1"
  CI: true

jobs:
  security-gate:
    name: "ðŸ”’ Security Gate"
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Trivy source scan
        id: trivy
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: fs
          scan-ref: .
          format: table
          severity: CRITICAL,HIGH
          exit-code: "0"
        continue-on-error: true

      - name: TruffleHog secret scan
        id: trufflehog
        uses: trufflesecurity/trufflehog@v3.78.0
        with:
          path: ./
          base: main
          head: HEAD
          extra_args: --only-verified
        continue-on-error: true

      - name: Security summary
        if: always()
        run: |
          echo "## ðŸ” Security summary" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.trivy.outcome }}" = "success" ]; then
            echo "- âœ… Trivy: no blocking CVEs" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âš ï¸ Trivy: review scan output" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ steps.trufflehog.outcome }}" = "success" ]; then
            echo "- âœ… TruffleHog: no verified secrets" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âš ï¸ Potential secrets detected" >> $GITHUB_STEP_SUMMARY
          fi

  quality:
    name: "ðŸ§ª Quality & Tests"
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: security-gate
    outputs:
      skipped: ${{ steps.skip.outputs.skip }}
    steps:
      - name: Determine skip flag
        id: skip
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ github.event.inputs.skip_tests }}" = "true" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        if: steps.skip.outputs.skip == 'false'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
          cache-dependency-path: |
            requirements.txt
            pyproject.toml

      - name: Install dependencies
        if: steps.skip.outputs.skip == 'false'
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          pip install -e .[dev]
          pip install radon xenon

      - name: Ruff
        if: steps.skip.outputs.skip == 'false'
        run: ruff check . --output-format=github

      - name: Black
        if: steps.skip.outputs.skip == 'false'
        run: black --check --diff .

      - name: MyPy
        if: steps.skip.outputs.skip == 'false'
        run: mypy domain/models --ignore-missing-imports

      - name: Bandit
        if: steps.skip.outputs.skip == 'false'
        run: bandit -r apps adapters domain ports -x tests

      - name: Safety
        if: steps.skip.outputs.skip == 'false'
        run: safety check --full-report --ignore-unpinned-requirements

      - name: Xenon complexity guard
        if: steps.skip.outputs.skip == 'false'
        run: xenon adapters apps domain ports --max-absolute B --max-modules B --max-average B

      - name: Radon complexity report
        if: steps.skip.outputs.skip == 'false'
        run: |
          radon cc adapters apps domain ports -nc --show-complexity --total-average > radon-report.txt
          radon raw adapters apps domain ports > radon-raw.txt

      - name: Run pytest suite
        if: steps.skip.outputs.skip == 'false'
        env:
          SAPTIVA_API_KEY: mock_saptiva_key
          TAVILY_API_KEY: mock_tavily_key
          VECTOR_BACKEND: none
          ENVIRONMENT: ci
          LOCAL_STORAGE_ROOT: ./runs/storage
        run: pytest -v --maxfail=1

      - name: Upload artifacts
        if: always() && steps.skip.outputs.skip == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: ci-quality-artifacts
          path: |
            htmlcov/
            coverage.xml
            radon-report.txt
            radon-raw.txt
            .pytest_cache
          if-no-files-found: ignore

      - name: Upload coverage to Codecov
        if: always() && steps.skip.outputs.skip == 'false'
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          flags: ci
          fail_ci_if_error: false

      - name: Quality summary
        if: always()
        run: |
          if [ "${{ steps.skip.outputs.skip }}" = "true" ]; then
            echo "## âš ï¸ Quality gate skipped" >> $GITHUB_STEP_SUMMARY
            echo "- Manual override requested (skip_tests=true)." >> $GITHUB_STEP_SUMMARY
          else
            echo "## âœ… Quality gate completed" >> $GITHUB_STEP_SUMMARY
            echo "- Linting, typing, security, and tests executed." >> $GITHUB_STEP_SUMMARY
            echo "- Coverage + radon reports uploaded as artifacts." >> $GITHUB_STEP_SUMMARY
          fi

  build-image:
    name: "ðŸ³ Build & Push Image"
    runs-on: ubuntu-latest
    needs: quality
    if: success()
    env:
      REGISTRY: ghcr.io
      IMAGE_NAME: ${{ github.repository }}
    outputs:
      image: ${{ steps.image-info.outputs.image }}
      tag: ${{ steps.image-info.outputs.tag }}
      digest: ${{ steps.build.outputs.digest }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Determine image tag
        id: image-info
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ github.event.inputs.image_tag }}" ]; then
            TAG="${{ github.event.inputs.image_tag }}"
          else
            case "${GITHUB_REF_NAME}" in
              develop)
                TAG="develop"
                ;;
              main)
                TAG="main"
                ;;
              *)
                SHORT="${GITHUB_SHA::12}"
                TAG="${GITHUB_REF_NAME//\//-}-$SHORT"
                ;;
            esac
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "image=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$TAG" >> $GITHUB_OUTPUT

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=${{ steps.image-info.outputs.tag }}
            type=ref,event=branch
            type=sha
          labels: |
            org.opencontainers.image.source=${{ github.repositoryUrl }}
            org.opencontainers.image.revision=${{ github.sha }}

      - name: Build and push
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          target: production
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

      - name: Generate SBOM
        uses: anchore/sbom-action@v0
        with:
          image: ${{ steps.image-info.outputs.image }}@${{ steps.build.outputs.digest }}
          format: spdx-json
          output-file: sbom.spdx.json

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom-${{ steps.image-info.outputs.tag }}
          path: sbom.spdx.json

  scan-image:
    name: "ðŸ›¡ï¸ Image Scan"
    runs-on: ubuntu-latest
    needs: build-image
    steps:
      - name: Trivy image scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ needs.build-image.outputs.image }}@${{ needs.build-image.outputs.digest }}
          format: sarif
          output: trivy-image.sarif

      - name: Upload Trivy SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-image.sarif

  deploy-staging:
    name: "ðŸš€ Deploy Staging"
    runs-on: ubuntu-latest
    needs: [build-image, scan-image]
    if: |
      github.ref == 'refs/heads/develop' ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    environment:
      name: staging
      url: http://34.42.214.246:8000
    steps:
      - name: Deploy to staging
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 34.42.214.246
          username: jf
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          port: 22
          script: |
            set -euo pipefail

            DEPLOY_DIR="/home/jf/aletheia-api"
            BACKUP_DIR="/home/jf/aletheia-staging-backup-$(date +%Y%m%d%H%M%S)"
            IMAGE_URI="${{ needs.build-image.outputs.image }}"

            echo "ðŸ“¦ Deploy directory: $DEPLOY_DIR"

            if [ -d "$DEPLOY_DIR/.git" ]; then
              echo "ðŸ’¾ Existing deployment detected, creating backup at $BACKUP_DIR"
              cp -R "$DEPLOY_DIR" "$BACKUP_DIR"
            else
              echo "ðŸ“¥ First time setup â€” cloning repository"
              git clone https://github.com/${{ github.repository }}.git "$DEPLOY_DIR"
            fi

            cd "$DEPLOY_DIR"
            git config --global --add safe.directory "$DEPLOY_DIR"
            git fetch --depth=1 origin develop
            git checkout develop
            git reset --hard origin/develop

            cd infra/docker
            touch .env
            sed -i '/^ALETHEIA_IMAGE=/d' .env
            sed -i '/^ALETHEIA_API_PORT=/d' .env
            echo "ALETHEIA_IMAGE=$IMAGE_URI" >> .env
            echo "ALETHEIA_API_PORT=8000" >> .env

            if command -v docker-compose >/dev/null 2>&1; then
              COMPOSE_CMD="docker-compose"
            else
              COMPOSE_CMD="docker compose"
            fi

            echo "ðŸ³ Using $COMPOSE_CMD"

            $COMPOSE_CMD -f docker-compose.yml pull aletheia-api || true
            $COMPOSE_CMD -f docker-compose.yml up -d --remove-orphans

            echo "âŒ› Waiting for health check"
            sleep 20
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/health || echo "000")

            if [ "$STATUS" != "200" ]; then
              echo "âŒ Deployment failed, rolling back"
              $COMPOSE_CMD -f docker-compose.yml down
              if [ -d "$BACKUP_DIR" ]; then
                rm -rf "$DEPLOY_DIR"
                mv "$BACKUP_DIR" "$DEPLOY_DIR"
                cd "$DEPLOY_DIR/infra/docker"
                $COMPOSE_CMD -f docker-compose.yml up -d --remove-orphans
              fi
              exit 1
            fi

            echo "âœ… Staging deployment healthy (HTTP $STATUS)"
            find /home/jf -maxdepth 1 -type d -name 'aletheia-staging-backup-*' | sort | head -n -2 | xargs -r rm -rf

  deploy-production:
    name: "ðŸš€ Deploy Production"
    runs-on: ubuntu-latest
    needs: [build-image, scan-image]
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production'
    environment:
      name: production
      url: http://34.42.214.246/alethia/
    steps:
      - name: Deploy to production
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 34.42.214.246
          username: jf
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          port: 22
          script: |
            set -euo pipefail

            DEPLOY_DIR="/home/jf/aletheia-api"
            BACKUP_DIR="/home/jf/aletheia-backup-$(date +%Y%m%d%H%M%S)"
            IMAGE_URI="${{ needs.build-image.outputs.image }}"

            if [ -d "$DEPLOY_DIR/.git" ]; then
              echo "ðŸ’¾ Existing deployment detected, creating backup at $BACKUP_DIR"
              cp -R "$DEPLOY_DIR" "$BACKUP_DIR"
            else
              echo "ðŸ“¥ Repository missing, cloning"
              git clone https://github.com/${{ github.repository }}.git "$DEPLOY_DIR"
            fi

            cd "$DEPLOY_DIR"
            git config --global --add safe.directory "$DEPLOY_DIR"
            git fetch --depth=1 origin main
            git checkout main
            git reset --hard origin/main

            cd infra/docker
            touch .env
            sed -i '/^ALETHEIA_IMAGE=/d' .env
            sed -i '/^ALETHEIA_API_PORT=/d' .env
            echo "ALETHEIA_IMAGE=$IMAGE_URI" >> .env
            echo "ALETHEIA_API_PORT=8002" >> .env

            if command -v docker-compose >/dev/null 2>&1; then
              COMPOSE_CMD="docker-compose"
            else
              COMPOSE_CMD="docker compose"
            fi

            echo "ðŸ³ Using $COMPOSE_CMD"
            $COMPOSE_CMD -f docker-compose.yml pull aletheia-api || true
            $COMPOSE_CMD -f docker-compose.yml up -d --remove-orphans

            echo "âŒ› Waiting for health check"
            sleep 25
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8002/health || echo "000")

            if [ "$STATUS" != "200" ]; then
              echo "âŒ Deployment failed, rolling back"
              $COMPOSE_CMD -f docker-compose.yml down
              if [ -d "$BACKUP_DIR" ]; then
                rm -rf "$DEPLOY_DIR"
                mv "$BACKUP_DIR" "$DEPLOY_DIR"
                cd "$DEPLOY_DIR/infra/docker"
                $COMPOSE_CMD -f docker-compose.yml up -d --remove-orphans
              fi
              exit 1
            fi

            echo "âœ… Production deployment healthy (HTTP $STATUS)"
            find /home/jf -maxdepth 1 -type d -name 'aletheia-backup-*' | sort | head -n -2 | xargs -r rm -rf

  summary:
    name: "ðŸ“‹ Pipeline Summary"
    runs-on: ubuntu-latest
    needs: [security-gate, quality, build-image, scan-image, deploy-staging, deploy-production]
    if: always()
    steps:
      - name: Publish summary
        run: |
          echo "## ðŸ“Š CI/CD summary" >> $GITHUB_STEP_SUMMARY
          echo "- Security gate: ${{ needs.security-gate.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Quality & tests: ${{ needs.quality.result }} (skipped=${{ needs.quality.outputs.skipped }})" >> $GITHUB_STEP_SUMMARY
          echo "- Image build: ${{ needs.build-image.result }} -> ${{ needs.build-image.outputs.image }}" >> $GITHUB_STEP_SUMMARY
          echo "- Image scan: ${{ needs.scan-image.result }}" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ needs.deploy-staging.result }}" ]; then
            echo "- Staging deploy: ${{ needs.deploy-staging.result }}" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -n "${{ needs.deploy-production.result }}" ]; then
            echo "- Production deploy: ${{ needs.deploy-production.result }}" >> $GITHUB_STEP_SUMMARY
          fi
